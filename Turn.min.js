function Canvas(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i.ctx=i.getContext("2d"),i}function Vector(t){this.x=t.x,this.y=t.y}function Turn(t){return this.transform=t.transform||1,this.width=t.width,this.height=t.height,t.width>t.height?this.padding=t.width/2:this.padding=t.height/2,this.canvas=new Canvas(t.width+2*this.padding,t.height+2*this.padding),this.ctx=this.canvas.ctx,this.images=t.images,this.mouse_use=!1,this.auto_use=!1,this}Vector.prototype.radian_to_angle=function(t){return 180*t/Math.PI},Vector.prototype.angle_to_radian=function(t){return t*Math.PI/180},Vector.prototype.get_name=function(){var t=0,e=0;return 0==this.x?t=1:0==this.y?t=2:(e=this.y/this.x*100,e=Math.round(e)/100),this.a=e,this.type=t,this.name=e+"+"+t,this.name},Vector.prototype.rotate=function(t){var e=this.angle_to_radian(t),i=Math.cos(e),s=Math.sin(e);return new Vector({x:this.x*i-this.y*s,y:this.y*i+this.x*s})},Vector.prototype.add=function(t){return new Vector({x:this.x+t.x,y:this.y+t.y})},Vector.prototype.sub=function(t){return new Vector({x:this.x-t.x,y:this.y-t.y})},Vector.prototype.dot=function(t){return this.x*t.x+this.y*t.y},Vector.prototype.mul=function(t){return new Vector({x:this.x*t,y:this.y*t})},Vector.prototype.div=function(t){if(0==t)throw"向量不能除0";return new Vector({x:this.x/t,y:this.y/t})},Vector.prototype.floor=function(){return this.x=this.x>>0,this.y=this.y>>0,this},Vector.prototype.ceil=function(){return this.floor().add({x:1,y:1}),this},Vector.prototype.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},Vector.prototype.len=function(){return isNaN(this.tmp_len)&&(this.tmp_len=Math.sqrt(this.x*this.x+this.y*this.y)),this.tmp_len},Vector.prototype.get_one_len=function(){return this.div(this.len())},Vector.prototype.len_square=function(){return isNaN(this.tmp_len)?isNaN(this.tmp_len_square)&&(this.tmp_len_square=this.x*this.x+this.y*this.y):this.tmp_len_square=this.tmp_len*this.tmp_len,this.tmp_len_square},Vector.prototype.projectVector=function(t){return this.mul(t/this.len_square())},Vector.prototype.OrthogonalVector=function(){return new Vector({x:-this.y,y:this.x})},Vector.prototype.get_a_b_type=function(t){var e=0,i=0,s=0;return t.x-this.x==0?e=1:t.y-this.y==0?e=2:(i=(t.y-this.y)/(t.x-this.x),s=(this.y*t.x-this.x*t.y)/(t.x-this.x)),{a:i,b:s,type:e,start:this,end:t}},Vector.prototype.get_line_inter_point=function(t,e,i,s){if(0!=t.type||0!=e.type){var n={use_count:0};if(1==t.type){var a=t.start.x;n.type=1,n.use=e,n.use_count++}else if(1==e.type){a=e.start.x;n.type=1,n.use=t,n.use_count++}else{if(e.a==t.a)return!1;a=(t.b-e.b)/(e.a-t.a)}if(2==t.type){var r=t.start.y;n.type=2,n.use=e,n.use_count++}else if(2==e.type){r=e.start.y;n.type=2,n.use=t,n.use_count++}else{if(e.a==t.a)return!1;r=(e.b*t.a-e.a*t.b)/(t.a-e.a)}if(1==n.use_count)if(1==n.type)r=n.use.a*a+n.use.b;else if(2==n.type){if(0==n.use.a)return!1;a=(r-n.use.b)/n.use.a}}else{if(e.a==t.a)return!1;a=(t.b-e.b)/(e.a-t.a),r=(e.b*t.a-e.a*t.b)/(t.a-e.a)}var h=new Vector({x:a,y:r}),o=!0;if(i){var d=(l=t.end.sub(t.start)).dot(h),c=l.dot(t.start),u=l.dot(t.end);o=o&&(c<d&&d<u)}if(s){var l;d=(l=e.end.sub(e.start)).dot(h),c=l.dot(e.start),u=l.dot(e.end);o=o&&(c<d&&d<u)}return!!o&&h},Vector.prototype.angle=function(t){if(t){var e=this.len()*t.len();return this.radian_to_angle(Math.acos(this.dot(t)/e))}return this.radian_to_angle(Math.atan2(this.y,this.x))},Turn.prototype.get_edge=function(t){for(var e=[],i=0;i<t.length;i++){var s=t[i],n=t[i+1];n||(n=t[0]),e.push(s.get_a_b_type(n))}return e},Turn.prototype.set_zone=function(){var t=this.width/3>>0,e=this.height/3>>0;this.zone_list=[];var i=[45,0,-45,90,-90,135,180,-135],s=this.width/2,n=this.height/2;if(n<s)var a=n;else a=s;for(var r=0;r<3;r++)for(var h=0;h<3;h++)if(1!=r||1!=h){var o=t*r,d=e*h,c=(o+=this.padding)+t,u=(d+=this.padding)+e,l=this.zone_list.length,g=i[l];if((g%=180)<0&&(g+=180),45==g||135==g)var p=a*a*2;else if(0==g)p=s*s;else if(90==g)p=n*n;this.zone_list.push({x:o,y:d,x1:c,y1:u,index:l,angle:i[l],limit_len:p})}},Turn.prototype.set_card=function(){this.card_corner=[new Vector({x:this.padding,y:this.padding}),new Vector({x:this.padding,y:this.padding+this.height}),new Vector({x:this.padding+this.width,y:this.padding+this.height}),new Vector({x:this.padding+this.width,y:this.padding})],this.card_edge=this.get_edge(this.card_corner)},Turn.prototype.set_limit=function(){this.limit_corner=[new Vector({x:0,y:0}),new Vector({x:0,y:this.canvas.height}),new Vector({x:this.canvas.width,y:this.canvas.height}),new Vector({x:this.canvas.width,y:0})],this.limit_edge=this.get_edge(this.limit_corner)},Turn.prototype.loadImage=function(r){this.images_dom=[];for(var t=0;t<this.images.length;t++){var e=new Image;e.onload=function(t,e){if(t.index=e,this.images_dom.push(t),this.images_dom.length==this.images.length){this.images_dom.sort(function(t,e){return t.index-e.index});for(e=0;e<this.images_dom.length;e++){t=this.images_dom[e];if(2==e){var i=t.naturalWidth/t.naturalHeight,s=this.width/3,n=s/i;(a=new Canvas(s,n).ctx).drawImage(t,0,0,s,n)}else{var a;(a=new Canvas(this.width,this.height).ctx).drawImage(t,0,0,t.naturalWidth,t.naturalHeight,0,0,this.width,this.height)}this.images_dom[e]=a.canvas}this.ctx.drawImage(this.images_dom[0],this.padding,this.padding),r&&r(this.images_dom)}}.bind(this,e,t),e.src=this.images[t]}},Turn.prototype.init=function(t){return this.loadImage(function(){this.set_zone(),this.set_card(),this.set_limit(),this.mouseEvent(),t&&t(this)}.bind(this)),this},Turn.prototype.cut=function(t,e,i){if(t.save(),t.globalCompositeOperation=i||"destination-out","Array"==e.constructor.name){t.beginPath();for(var s=0;s<e.length;s++)0==s?t.moveTo(e[s].x,e[s].y):t.lineTo(e[s].x,e[s].y);t.closePath(),t.fill()}else t.drawImage(e,0,0,e.width,e.height,this.padding,this.padding,e.width,e.height);t.restore()},Turn.prototype.shadow=function(t,e){var i=new Canvas(this.canvas.width,this.canvas.height).ctx;i.save(),i.fillStyle="rgba(255,255,255,1)",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=20,i.shadowColor="rgba(0, 0, 0, 1)",i.beginPath();for(var s=0;s<e.length;s++)0==s?i.moveTo(e[s].x,e[s].y):i.lineTo(e[s].x,e[s].y);i.closePath(),i.fill(),i.restore(),this.cut(i,e),t.drawImage(i.canvas,0,0)},Turn.prototype.debug=function(t,e){t.style="position:absolute;top:0;left:0;";var i=document.getElementById("gogo");e&&(i.innerHTML=""),i.appendChild(t)},Turn.prototype.help_point=function(t,e,i){e||(e=this.ctx),e.save(),e.fillStyle=i||"#000000",e.beginPath(),e.arc(t.x,t.y,10,0,2*Math.PI),e.closePath(),e.fill(),e.restore()},Turn.prototype.mouseEvent=function(){if(this.mobile)var t="touchstart",e="touchend",i="touchmove";else t="mousedown",e="mouseup",i="mousemove";this.canvas.addEventListener(t,this.mouseDown.bind(this)),document.addEventListener(e,this.mouseUp.bind(this)),document.addEventListener(i,this.mouseMove.bind(this))},Turn.prototype.get_zone=function(t){for(var e=0;e<this.zone_list.length;e++){var i=this.zone_list[e].x,s=this.zone_list[e].x1,n=this.zone_list[e].y,a=this.zone_list[e].y1;if(i<t.x&&n<t.y&&s>t.x&&a>t.y)return this.zone_list[e]}return!1},Turn.prototype.mouseDown=function(t){if(!this.mouse_use&&!this.auto_use){this.canvas_vec=new Vector(this.canvas.getBoundingClientRect()).add({x:window.scrollX,y:window.scrollY}),this.device?this.start=new Vector({x:t.changedTouches[0].pageX,y:t.changedTouches[0].pageY}):this.start=new Vector({x:t.pageX,y:t.pageY}),this.start=this.start.sub(this.canvas_vec).div(this.transform);var e=this.get_zone(this.start);if(e){this.zone_data=e,this.mouse_use=!0;for(var i=[],s=0;s<this.card_corner.length;s++){var n=this.card_corner[s].sub(this.start).len_square();i.push({corner:this.card_corner[s],len_square:n,index:s})}i.sort(function(t,e){return t.len_square-e.len_square}),this.close_corner_index=i[0].index,this.end=this.start}}},Turn.prototype.mouseMove=function(t){if(!this.mouse_use)return!1;if(this.auto_use)return!1;var e=this.start;if(this.device)var i=new Vector({x:t.changedTouches[0].pageX,y:t.changedTouches[0].pageY});else i=new Vector({x:t.pageX,y:t.pageY});if(i=i.sub(this.canvas_vec).div(this.transform),!(s=i.sub(e)).len_square())return!1;var s=(i=new Vector({x:s.len(),y:0}).rotate(this.zone_data.angle).add(e)).sub(e);if(this.work(s),s.len_square()>=this.zone_data.limit_len){var n=Date.now();window.requestAnimationFrame(function(){var t=Date.now()-n,e=1+t/500,i=s.mul(e);i.len_square()&&(this.work(i),t<=500?window.requestAnimationFrame(arguments.callee.bind(this)):(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images_dom[1],this.padding,this.padding)))}.bind(this)),this.mouse_use=!1}else this.end=i},Turn.prototype.mouseUp=function(t){if(!this.mouse_use)return!1;if(this.auto_use)return!1;this.mouse_use=!1;var s=this.end.sub(this.start);if(s.len_square()){var n=Date.now();window.requestAnimationFrame(function(){var t=Date.now()-n,e=1-t/200,i=s.mul(e);i.len_square()&&(this.work(i),t<=200?window.requestAnimationFrame(arguments.callee.bind(this)):(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images_dom[0],this.padding,this.padding)))}.bind(this))}else this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images_dom[0],this.padding,this.padding)},Turn.prototype.work=function(t){for(var e=this.card_corner[this.close_corner_index].add(t),i=e.add(t.OrthogonalVector()),s=e.get_a_b_type(i),n=[],a=[],r=0;r<this.limit_edge.length;r++){(d=Vector.prototype.get_line_inter_point(this.limit_edge[r],s))&&0<=d.x&&0<=d.y&&d.x<=this.canvas.width&&d.y<=this.canvas.height&&a.push(d)}if(!a.length)return!1;var h=t.get_one_len().mul(2*this.canvas.width);n.push(a[0]),n.push(a[1]),n.push(a[1].sub(h)),n.push(a[0].sub(h));var o=[];for(r=0;r<this.card_edge.length;r++){var d;(d=Vector.prototype.get_line_inter_point(this.card_edge[r],s))&&(d.x>=this.padding&&d.y>=this.padding&&d.x<=this.canvas.width-this.padding&&d.y<=this.canvas.height-this.padding&&o.push(d))}if(!o.length)return!1;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images_dom[0],this.padding,this.padding);var c=o[0].add(o[1]).div(2),u=o[0].sub(o[1]).angle(),l=new Vector({x:this.canvas.width-c.x,y:c.y}),g=new Vector({x:this.canvas.width-o[0].x,y:o[0].y}),p=new Vector({x:this.canvas.width-o[1].x,y:o[1].y}),_=u-g.sub(p).angle();this.card_n_process(this.images_dom[1].ctx,c,l,_),this.shadow(this.ctx,[o[0],o[1],this.card_corner[this.close_corner_index]]),this.cut(this.ctx,n),this.finger_process(this.images_dom[2].ctx,c,l,_)},Turn.prototype.finger_process=function(t,e,i,s){var n=this.zone_data.angle-s-90,a=new Vector({x:this.padding,y:this.padding}).add(e.sub(i)),r={x:t.canvas.width/2.5,y:t.canvas.height/5},h=[{vec:r,angle:[90,135,180]},{vec:{x:this.width-r.x,y:r.y},angle:[45]},{vec:{x:this.width-r.x,y:this.height-r.y},angle:[0,-45,-90]},{vec:{x:r.x,y:this.height-r.y},angle:[-135]}];this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(s*Math.PI/180),this.ctx.translate(-e.x,-e.y);for(var o=0;o<h.length;o++)if(-1!=h[o].angle.indexOf(this.zone_data.angle)){var d=a.add(h[o].vec);this.ctx.save(),this.ctx.translate(d.x,d.y),this.ctx.rotate(n*Math.PI/180),this.ctx.translate(-d.x,-d.y);var c=d.sub(r);this.ctx.drawImage(t.canvas,c.x,c.y),this.ctx.restore()}this.ctx.restore()},Turn.prototype.card_n_process=function(t,e,i,s){var n=new Vector({x:this.padding,y:this.padding}).add(e.sub(i));this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(s*Math.PI/180),this.ctx.translate(-e.x,-e.y),this.ctx.drawImage(t.canvas,n.x,n.y),this.ctx.restore()},Turn.prototype.rnd_turn=function(t){if(this.mouse_use)return!1;if(this.auto_use)return!1;this.auto_use=!0,t||(t={});var e=t.rnd_index,i=(t.millisecond,t.finish_func);t.type;if(isNaN(e))e=this.zone_list.length*Math.random()>>0;var s=this.zone_list[e];if(!s)return!1;this.zone_data=s;for(var n=[],a=0;a<this.card_corner.length;a++){var r=this.card_corner[a].sub(new Vector({x:this.zone_data.x,y:this.zone_data.y})).len_square();n.push({index:a,len_square:r})}n.sort(function(t,e){return t.len_square-e.len_square}),this.close_corner_index=n[0].index;var h=this.zone_data.angle,o=new Vector(this.card_corner[this.close_corner_index]),d=new Vector({x:1,y:0}).rotate(h).add(o).sub(o),c=d.get_one_len(),u=4*this.zone_data.limit_len,l=u/49,g=u/16,p=!0,_=c.mul(1),y=null;window.requestAnimationFrame(function(){var t=(d=d.add(_)).len_square();p&&l<t?(_=c.mul(.4),p=!1):g<t&&(_=_.mul(1.03)),this.work(d),t<u?y=window.requestAnimationFrame(arguments.callee.bind(this)):(this.mouse_use=!1,this.auto_use=!1,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.images_dom[1],this.padding,this.padding),cancelAnimationFrame(y),i&&i())}.bind(this))};